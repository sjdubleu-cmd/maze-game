<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<title>DOOM 스타일 미로 게임</title>
<style>
  html, body { margin: 0; padding: 0; overflow: hidden; background: black; }
  canvas { display: block; width: 100vw; height: 100vh; }
  #levelText {
    position: fixed; top: 10px; left: 10px;
    color: white; font-size: 20px; font-family: monospace;
  }
</style>
</head>
<body>
<canvas id="game" width="640" height="480"></canvas>
<div id="levelText">레벨 1</div>

<script>
const canvas = document.getElementById("game");
const ctx = canvas.getContext("2d");

// ===== 기본 설정 =====
let level = 1;
let mapSize = 8;
let map, mapW, mapH;
let player = { x: 3.5, y: 3.5, dir: 0, fov: Math.PI / 3 };
const moveSpeed = 0.05, rotSpeed = 0.05;
let keys = {};

window.addEventListener("keydown", e => keys[e.key] = true);
window.addEventListener("keyup", e => keys[e.key] = false);

// ===== 맵 생성 =====
function generateMap(size) {
  const newMap = Array.from({length: size}, () => Array(size).fill(0));
  for (let y = 0; y < size; y++) {
    for (let x = 0; x < size; x++) {
      if (x === 0 || y === 0 || x === size-1 || y === size-1) newMap[y][x] = 1;
      else if (Math.random() < 0.2) newMap[y][x] = 1;
    }
  }
  newMap[size-2][size-2] = 2; // 출구
  return newMap;
}

function resetLevel() {
  map = generateMap(mapSize);
  mapW = mapH = map.length;
  player.x = 1.5;
  player.y = 1.5;
  player.dir = 0;
  document.getElementById("levelText").textContent = "레벨 " + level;
}

// ===== 레이캐스팅 =====
function castRays() {
  const w = canvas.width, h = canvas.height;
  const distProj = (w/2)/Math.tan(player.fov/2);
  for (let x=0; x<w; x++) {
    const rayAngle = player.dir - player.fov/2 + (x/w)*player.fov;
    let dist=0, hit=false, hitType=0;
    const step=0.05;
    while (!hit && dist < 20) {
      dist += step;
      const rx = player.x + Math.cos(rayAngle)*dist;
      const ry = player.y + Math.sin(rayAngle)*dist;
      if (map[Math.floor(ry)] && map[Math.floor(ry)][Math.floor(rx)] > 0) {
        hit = true;
        hitType = map[Math.floor(ry)][Math.floor(rx)];
      }
    }
    if (hit) {
      const wallH = (1/dist)*distProj;
      const shade = Math.max(0, 255 - dist*40);
      if (hitType === 2) ctx.fillStyle = `rgb(${shade},${shade*0.3},${shade*0.3})`;
      else ctx.fillStyle = `rgb(${shade*0.8},${shade},${shade*0.8})`;
      ctx.fillRect(x, h/2 - wallH/2, 1, wallH);
    }
  }
}

// ===== 플레이어 이동 =====
function update() {
  if (keys["ArrowLeft"]) player.dir -= rotSpeed;
  if (keys["ArrowRight"]) player.dir += rotSpeed;

  let nx = player.x, ny = player.y;
  if (keys["ArrowUp"]) {
    nx += Math.cos(player.dir) * moveSpeed;
    ny += Math.sin(player.dir) * moveSpeed;
  }
  if (keys["ArrowDown"]) {
    nx -= Math.cos(player.dir) * moveSpeed;
    ny -= Math.sin(player.dir) * moveSpeed;
  }

  if (map[Math.floor(ny)][Math.floor(player.x)] === 0) player.y = ny;
  if (map[Math.floor(player.y)][Math.floor(nx)] === 0) player.x = nx;

  // 출구 도달 시
  if (map[Math.floor(player.y)][Math.floor(player.x)] === 2) {
    level++;
    mapSize = Math.min(mapSize + 2, 50);
    resetLevel();
  }
}

// ===== 화면 렌더링 =====
function render() {
  const w = canvas.width, h = canvas.height;
  ctx.fillStyle="#202020";
  ctx.fillRect(0,0,w,h/2);
  ctx.fillStyle="#3a3a3a";
  ctx.fillRect(0,h/2,w,h/2);
  castRays();
}

// ===== 메인 루프 =====
function loop(){
  update();
  render();
  requestAnimationFrame(loop);
}

resetLevel();
loop();
</script>
</body>
</html>
